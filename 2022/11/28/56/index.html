<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>性能剖析大杀器 pprof | lizhewei&#39;s Blog</title>
  <meta name="description" content="pprof在 Go 语言中，PProf 是用于可视化和分析性能分析数据的工具，pprof 以 profile.proto 读取分析样本的集合，并生成报告以可视化并帮助分析数据（支持文本和图形报告）。 而刚刚提到的 profile.proto 是一个 Protobuf v3 的描述文件，它描述了一组 callstack 和 symbolization 信息， 作用是统计分析的一组采样的调用栈，是很常">
<meta property="og:type" content="article">
<meta property="og:title" content="性能剖析大杀器 pprof">
<meta property="og:url" content="http://lizhewei91.github.io/2022/11/28/56/index.html">
<meta property="og:site_name" content="lizhewei&#39;Blog">
<meta property="og:description" content="pprof在 Go 语言中，PProf 是用于可视化和分析性能分析数据的工具，pprof 以 profile.proto 读取分析样本的集合，并生成报告以可视化并帮助分析数据（支持文本和图形报告）。 而刚刚提到的 profile.proto 是一个 Protobuf v3 的描述文件，它描述了一组 callstack 和 symbolization 信息， 作用是统计分析的一组采样的调用栈，是很常">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://lizhewei91.github.io/2022/11/28/56/1639809085480-2c7d9448-375f-4b98-913e-81020195a0c6-20221128222049403.png">
<meta property="og:image" content="http://lizhewei91.github.io/2022/11/28/56/1639561832030-18ced959-237a-4a72-9121-a05850d0e4b9.png">
<meta property="og:image" content="http://lizhewei91.github.io/2022/11/28/56/1639561878713-40879f4c-8c9b-429d-bff5-bcfdffc32fc1.png">
<meta property="og:image" content="http://lizhewei91.github.io/2022/11/28/56/1639561986430-2a11499e-5106-4273-8ce7-85caacd60ac0.png">
<meta property="og:image" content="http://lizhewei91.github.io/2022/11/28/56/1639562053535-d85c624d-78ca-4460-93a2-d46fdb060ca1.png">
<meta property="og:image" content="http://lizhewei91.github.io/2022/11/28/56/1639562087329-46ed34bf-0b80-4510-bc2c-9dbf5b34a0da.png">
<meta property="og:image" content="http://lizhewei91.github.io/2022/11/28/56/1639568828478-ad6f5933-8572-4dbd-b73d-f637ba70a610-20221128223022437.png">
<meta property="og:image" content="http://lizhewei91.github.io/2022/11/28/56/1639568868468-031d2b33-b044-4827-a283-5bd689ab07d3-20221128223104007.png">
<meta property="article:published_time" content="2022-11-28T12:28:56.000Z">
<meta property="article:modified_time" content="2023-06-01T07:36:49.829Z">
<meta property="article:author" content="lizhewei">
<meta property="article:tag" content="pprof">
<meta property="article:tag" content="性能分析">
<meta property="article:tag" content="golang">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://lizhewei91.github.io/2022/11/28/56/1639809085480-2c7d9448-375f-4b98-913e-81020195a0c6-20221128222049403.png">
  <!-- Canonical links -->
  <link rel="canonical" href="http://lizhewei91.github.io/2022/11/28/56/index.html">
  
    <link rel="alternate" href="/atom.xml" title="lizhewei&#39;Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 5.4.2"></head>


<body class="main-center" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/lizhewei91" target="_blank">
          <img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">李哲伟</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">Cloud Natural Developer</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Beijing, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">标签</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">项目</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">关于</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/lizhewei91" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      
  <div class="widget">
    <h3 class="widget-title">分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/buildx/">buildx</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/deploy-k8s/">deploy-k8s</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/device-plugins/">device-plugins</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/krew/">krew</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/kubelet/">kubelet</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/pprof/">pprof</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/reloader/">reloader</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签</h3>
    <div class="widget-body">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/allocatable/" rel="tag">allocatable</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/buildx/" rel="tag">buildx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/configMap/" rel="tag">configMap</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cri/" rel="tag">cri</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/deploy-k8s/" rel="tag">deploy-k8s</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/device-manager/" rel="tag">device-manager</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/device-plugins/" rel="tag">device-plugins</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang/" rel="tag">golang</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gpu/" rel="tag">gpu</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/" rel="tag">hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/krew/" rel="tag">krew</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubeadm/" rel="tag">kubeadm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubectl-plugins/" rel="tag">kubectl-plugins</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubelet/" rel="tag">kubelet</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubernetnes/" rel="tag">kubernetnes</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubevirt-gpu-device-plugin/" rel="tag">kubevirt-gpu-device-plugin</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/manifest/" rel="tag">manifest</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nvidia/" rel="tag">nvidia</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pprof/" rel="tag">pprof</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reloader/" rel="tag">reloader</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/secret/" rel="tag">secret</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/volume-manager/" rel="tag">volume-manager</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/" rel="tag">性能分析</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">归档</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">三月 2023</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">二月 2023</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">一月 2023</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">十一月 2022</a><span class="archive-list-count">3</span></li></ul>
    </div>
  </div>


    
  </div>
</aside>

  
  
  <aside class="sidebar sidebar-toc collapse   in  " id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#pprof"><span class="toc-number">1.</span> <span class="toc-text">pprof</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E4%BB%A5%E5%81%9A%E4%BB%80%E4%B9%88"><span class="toc-number">1.1.</span> <span class="toc-text">可以做什么</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%87%87%E6%A0%B7%E6%96%B9%E5%BC%8F"><span class="toc-number">1.2.</span> <span class="toc-text">采样方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.3.</span> <span class="toc-text">使用模式</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%9E%8B%E5%BA%94%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">服务型应用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%88%9D%E5%A7%8B%E5%8C%96net-http-pprof"><span class="toc-number">2.1.</span> <span class="toc-text">为什么要初始化net&#x2F;http&#x2F;pprof</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E4%BE%8B%E5%AD%90"><span class="toc-number">2.2.</span> <span class="toc-text">一个简单的例子</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AE%BF%E9%97%AE"><span class="toc-number">2.2.1.</span> <span class="toc-text">通过浏览器访问</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E4%BA%A4%E4%BA%92%E5%BC%8F%E7%BB%88%E7%AB%AF%E4%BD%BF%E7%94%A8"><span class="toc-number">2.2.2.</span> <span class="toc-text">通过交互式终端使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CPU-Profiling"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">CPU Profiling</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Heap-Profiling"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">Heap Profiling</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Goroutine-Profiling"><span class="toc-number">2.2.2.3.</span> <span class="toc-text">Goroutine Profiling</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Mutex-Profiling"><span class="toc-number">2.2.2.4.</span> <span class="toc-text">Mutex Profiling</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Block-Profiling"><span class="toc-number">2.2.2.5.</span> <span class="toc-text">Block Profiling</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%8F%AF%E8%A7%86%E5%8C%96%E7%95%8C%E9%9D%A2"><span class="toc-number">2.2.3.</span> <span class="toc-text">查看可视化界面</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Top"><span class="toc-number">2.2.3.1.</span> <span class="toc-text">Top</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Graph"><span class="toc-number">2.2.3.2.</span> <span class="toc-text">Graph</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Peek"><span class="toc-number">2.2.3.3.</span> <span class="toc-text">Peek</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Source"><span class="toc-number">2.2.3.4.</span> <span class="toc-text">Source</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#flame-graph"><span class="toc-number">2.2.3.5.</span> <span class="toc-text">flame graph</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E5%9E%8B%E5%BA%94%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">工具型应用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CPU%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90"><span class="toc-number">3.1.</span> <span class="toc-text">CPU性能分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">3.2.</span> <span class="toc-text">内存性能优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-number">3.3.</span> <span class="toc-text">示例</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8E%8B%E6%B5%8B%E5%B7%A5%E5%85%B7wrk"><span class="toc-number">4.</span> <span class="toc-text">压测工具wrk</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#pprof%E4%B8%8E%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E7%BB%93%E5%90%88"><span class="toc-number">5.</span> <span class="toc-text">pprof与性能测试结合</span></a></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-golang-pprof" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      性能剖析大杀器 pprof
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2022/11/28/56/" class="article-date">
	  <time datetime="2022-11-28T12:28:56.000Z" itemprop="datePublished">2022-11-28</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/pprof/">pprof</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link-link" href="/tags/golang/" rel="tag">golang</a>, <a class="article-tag-link-link" href="/tags/pprof/" rel="tag">pprof</a>, <a class="article-tag-link-link" href="/tags/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/" rel="tag">性能分析</a>
  </span>


        

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2022/11/28/56/#comments" class="article-comment-link">评论</a></span>
        
	
		<span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 5.6k(字)</span>
	
	
		<span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长: 24(分)</span>
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h1 id="pprof"><a href="#pprof" class="headerlink" title="pprof"></a>pprof</h1><p>在 Go 语言中，PProf 是用于可视化和分析性能分析数据的工具，pprof 以 profile.proto 读取分析样本的集合，并生成报告以可视化并帮助分析数据（支持文本和图形报告）。</p>
<p>而刚刚提到的 profile.proto 是一个 Protobuf v3 的描述文件，它描述了一组 callstack 和 symbolization 信息， 作用是统计分析的一组采样的调用栈，是很常见的 stacktrace 配置文件格式。</p>
<h2 id="可以做什么"><a href="#可以做什么" class="headerlink" title="可以做什么"></a>可以做什么</h2><ul>
<li><strong>CPU Profiling</strong>：CPU 分析，按照一定的频率采集所监听的应用程序 CPU（含寄存器）的使用情况，可确定应用程序在主动消耗 CPU 周期时花费时间的位置。</li>
<li><strong>Memory Profiling</strong>：内存分析，在应用程序进行堆分配时记录堆栈跟踪，用于监视当前和历史内存使用情况，以及检查内存泄漏。</li>
<li><strong>Block Profiling</strong>：阻塞分析，记录Goroutine阻塞等待同步（包括定时器通道）的位置，默认不开启，需要调用 <code>runtime.SetBlockProfileRate</code>进行设置。</li>
<li><strong>Mutex Profiling</strong>：互斥锁分析，报告互斥锁的竞争情况，默认不开启，需要调用 <code>runtime.SetMutexProfileFraction </code>进行设置。</li>
<li><strong>Goroutine Profiling</strong>：Goroutine 分析，可以对当前应用程序正在运行的 Goroutine 进行堆栈跟踪和分析。</li>
</ul>
<p>其中像是 Goroutine Profiling 这项功能会在实际排查中会经常用到。因为很多问题出现时的表象就是 Goroutine 暴增，而这时候我们要做的事情之一就是查看应用程序中的 Goroutine 正在做什么事情，因为什么阻塞了，然后再进行下一步。</p>
<h2 id="采样方式"><a href="#采样方式" class="headerlink" title="采样方式"></a>采样方式</h2><ul>
<li><strong>runtime/pprof</strong>：采集程序（非 Server）的指定区块的运行数据进行分析。</li>
<li><strong>net/http/pprof</strong>：基于HTTP Server运行，并且可以采集运行时数据进行分析。</li>
<li><strong>go test</strong>：通过运行测试用例，并指定所需标识来进行采集。</li>
</ul>
<h2 id="使用模式"><a href="#使用模式" class="headerlink" title="使用模式"></a>使用模式</h2><ul>
<li>Report generation：报告生成。</li>
<li>Interactive terminal use：交互式终端使用。</li>
<li>Web interface：Web 界面。</li>
</ul>
<h1 id="服务型应用"><a href="#服务型应用" class="headerlink" title="服务型应用"></a>服务型应用</h1><p>如果你的应用程序是一直运行的，比如 web 应用，那么可以使用<code>net/http/pprof</code>库，它能够在提供 HTTP 服务进行分析。</p>
<p>如果使用了默认的 <code>http.DefaultServeMux</code>（通常是代码直接使用 <code>http.ListenAndServe(“0.0.0.0:8080”, nil)</code>），只需要在你的web server端代码中按如下方式导入<code>net/http/pprof</code></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> _ <span class="string">&quot;net/http/pprof&quot;</span> </span><br></pre></td></tr></table></figure>

<h2 id="为什么要初始化net-http-pprof"><a href="#为什么要初始化net-http-pprof" class="headerlink" title="为什么要初始化net/http/pprof"></a>为什么要初始化net/http/pprof</h2><p>在我们的例子中，你会发现我们在引用上对 <code>net/http/pprof</code>包进行了默认的初始化（也就是 _），如果你曾经漏了，或者没加，你会发现压根调用不了 pprof 的相关接口，这是为什么呢，我们一起看看下面该包的初始化方法，如下：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line"> http.HandleFunc(<span class="string">&quot;/debug/pprof/&quot;</span>, Index)</span><br><span class="line"> http.HandleFunc(<span class="string">&quot;/debug/pprof/cmdline&quot;</span>, Cmdline)</span><br><span class="line"> http.HandleFunc(<span class="string">&quot;/debug/pprof/profile&quot;</span>, Profile)</span><br><span class="line"> http.HandleFunc(<span class="string">&quot;/debug/pprof/symbol&quot;</span>, Symbol)</span><br><span class="line"> http.HandleFunc(<span class="string">&quot;/debug/pprof/trace&quot;</span>, Trace)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际上 <code>net/http/pprof</code>会在初始化函数中对标准库中<code>net/http</code>所默认提供的 <code>DefaultServeMux</code> 进行路由注册，源码如下：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> DefaultServeMux = &amp;defaultServeMux</span><br><span class="line"><span class="keyword">var</span> defaultServeMux ServeMux</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HandleFunc</span><span class="params">(pattern <span class="type">string</span>, handler <span class="keyword">func</span>(ResponseWriter, *Request)</span></span>) &#123;</span><br><span class="line"> DefaultServeMux.HandleFunc(pattern, handler)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而我们在例子中使用的 HTTP Server，也是使用的标准库中默认提供的，因此便完美的结合在了一起，这也恰好也是最小示例的模式。</p>
<p>这时候你可能会注意到另外一个问题，那就是我们的实际项目中，都是有相对独立的 ServeMux 的，这时候我们只要仿照着将 pprof 对应的路由注册进去就好了，如下：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">mux := http.NewServeMux()</span><br><span class="line">mux.HandleFunc(<span class="string">&quot;/debug/pprof/&quot;</span>, pprof.Index)</span><br><span class="line">mux.HandleFunc(<span class="string">&quot;/debug/pprof/cmdline&quot;</span>, pprof.Cmdline)</span><br><span class="line">mux.HandleFunc(<span class="string">&quot;/debug/pprof/profile&quot;</span>, pprof.Profile)</span><br><span class="line">mux.HandleFunc(<span class="string">&quot;/debug/pprof/symbol&quot;</span>, pprof.Symbol)</span><br><span class="line">mux.HandleFunc(<span class="string">&quot;/debug/pprof/trace&quot;</span>, pprof.Trace)</span><br></pre></td></tr></table></figure>

<p>如果你使用的是gin框架，那么推荐使用 <a target="_blank" rel="noopener" href="https://github.com/gin-contrib/pprof">github.com/gin-contrib/pprof</a>，在代码中通过以下命令注册 pprof 相关路由。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">pprof.Register(router)</span><br></pre></td></tr></table></figure>

<h2 id="一个简单的例子"><a href="#一个简单的例子" class="headerlink" title="一个简单的例子"></a>一个简单的例子</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	_ <span class="string">&quot;net/http/pprof&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> datas []<span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	str := <span class="string">&quot;hello,world&quot;</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			log.Printf(<span class="string">&quot;len:%d\n&quot;</span>, Add(str))</span><br><span class="line">			time.Sleep(<span class="number">10</span> * time.Millisecond)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	_ = http.ListenAndServe(<span class="string">&quot;0.0.0.0:8080&quot;</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Add</span><span class="params">(str <span class="type">string</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">	datas = <span class="built_in">append</span>(datas, str)</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(datas)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来我们运行这个程序，访问 <code>http://127.0.0.1:8080/debug/pprof/</code> 地址，检查是否正常响应。</p>
<h3 id="通过浏览器访问"><a href="#通过浏览器访问" class="headerlink" title="通过浏览器访问"></a>通过浏览器访问</h3><p>第一种方式，我们可以直接通过浏览器，进行查看，那么在第一步我们可以先查看总览页面，也就是访问 <code>http://127.0.0.1:8080/debug/pprof/</code>，如下：    </p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">/debug/pprof/</span><br><span class="line"></span><br><span class="line">Types of profiles available:</span><br><span class="line">Count	Profile</span><br><span class="line"><span class="number">3</span>	allocs</span><br><span class="line"><span class="number">0</span>	block</span><br><span class="line"><span class="number">0</span>	cmdline</span><br><span class="line"><span class="number">5</span>	goroutine</span><br><span class="line"><span class="number">3</span>	heap</span><br><span class="line"><span class="number">0</span>	mutex</span><br><span class="line"><span class="number">0</span>	profile</span><br><span class="line"><span class="number">8</span>	threadcreate</span><br><span class="line"><span class="number">0</span>	trace</span><br><span class="line">full goroutine stack dump</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>allocs</strong>：查看过去所有内存分配的样本，访问路径为<code>$HOST/debug/pprof/allocs</code>。</li>
<li><strong>block</strong>：查看导致阻塞同步的堆栈跟踪，访问路径为<code>$HOST/debug/pprof/block</code>。</li>
<li><strong>cmdline</strong>：当前程序的命令行的完整调用路径，访问路径为<code>$HOST/debug/pprof/cmdline</code>。</li>
<li><strong>goroutine</strong>：查看当前所有运行的 goroutines 堆栈跟踪，访问路径为<code>$HOST/debug/pprof/goroutine</code>。</li>
<li><strong>heap</strong>：查看活动对象的内存分配情况， 访问路径为<code>$HOST/debug/pprof/heap</code>。</li>
<li><strong>mutex</strong>：查看导致互斥锁的竞争持有者的堆栈跟踪，访问路径为<code>$HOST/debug/pprof/mutex</code>。</li>
<li><strong>profile</strong>：默认进行 30s 的 CPU Profiling，得到一个分析用的 profile 文件，访问路径为<code>$HOST/debug/pprof/profile</code>。</li>
<li><strong>threadcreate</strong>：查看创建新OS线程的堆栈跟踪，访问路径为<code>$HOST/debug/pprof/threadcreate</code>。</li>
</ul>
<p>如果在相应的路径上加“<code>?debug=1</code>”，则可以直接在浏览器中访问，如图所示：</p>
<img src="/2022/11/28/56/1639809085480-2c7d9448-375f-4b98-913e-81020195a0c6-20221128222049403.png" class="" title="image.png">

<blockquote>
<p>若不新增debug参数，则会直接下载对应的profile文件。</p>
<p><strong>注意：</strong>debug的访问方式具有时效性，在实际场景中，我们通常将profile文件保存下来，便于二次分析。</p>
</blockquote>
<h3 id="通过交互式终端使用"><a href="#通过交互式终端使用" class="headerlink" title="通过交互式终端使用"></a>通过交互式终端使用</h3><h4 id="CPU-Profiling"><a href="#CPU-Profiling" class="headerlink" title="CPU Profiling"></a>CPU Profiling</h4><p>第二种方式，我们可以直接通过命令行，来完成对正在运行的应用程序 pprof 的抓取和分析。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">$ <span class="keyword">go</span> tool pprof http:<span class="comment">//localhost:8080/debug/pprof/profile?seconds=60</span></span><br><span class="line">Fetching profile over HTTP from http:<span class="comment">//localhost:6060/debug/pprof/profile?seconds=60</span></span><br><span class="line">Saved profile in /Users/eddycjy/pprof/pprof.samples.cpu<span class="number">.002</span>.pb.gz</span><br><span class="line">Type: cpu</span><br><span class="line">Duration: <span class="number">1</span>mins, Total samples = <span class="number">37.25</span>s (<span class="number">61.97</span>%)</span><br><span class="line">Entering interactive mode (<span class="keyword">type</span> <span class="string">&quot;help&quot;</span> <span class="keyword">for</span> commands, <span class="string">&quot;o&quot;</span> <span class="keyword">for</span> options)</span><br><span class="line">(pprof)</span><br></pre></td></tr></table></figure>

<p>执行该命令后，需等待 60 秒（可调整 seconds 的值），pprof 会进行 CPU Profiling，结束后将默认进入 pprof 的命令行交互式模式，可以对分析的结果进行查看或导出。另外如果你所启动的 HTTP Server 是 TLS 的方式，那么在调用<code>go tool pprof</code> 时，需要将调用路径改为：<code>go tool pprof https+insecure://localhost:8080/debug/pprof/profile\?seconds\=60</code>。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">(pprof) top10</span><br><span class="line">Showing nodes accounting <span class="keyword">for</span> <span class="number">1.38</span>s, <span class="number">100</span>% of <span class="number">1.38</span>s total</span><br><span class="line">Showing top <span class="number">10</span> nodes out of <span class="number">50</span></span><br><span class="line">      flat  flat%   sum%        cum   cum%</span><br><span class="line">     <span class="number">0.60</span>s <span class="number">43.48</span>% <span class="number">43.48</span>%      <span class="number">0.80</span>s <span class="number">57.97</span>%  runtime.kevent</span><br><span class="line">     <span class="number">0.31</span>s <span class="number">22.46</span>% <span class="number">65.94</span>%      <span class="number">0.31</span>s <span class="number">22.46</span>%  runtime.libcCall</span><br><span class="line">     <span class="number">0.21</span>s <span class="number">15.22</span>% <span class="number">81.16</span>%      <span class="number">0.22</span>s <span class="number">15.94</span>%  syscall.syscall</span><br><span class="line">     <span class="number">0.15</span>s <span class="number">10.87</span>% <span class="number">92.03</span>%      <span class="number">0.26</span>s <span class="number">18.84</span>%  runtime.pthread_cond_wait</span><br><span class="line">     <span class="number">0.04</span>s  <span class="number">2.90</span>% <span class="number">94.93</span>%      <span class="number">0.04</span>s  <span class="number">2.90</span>%  runtime.pthread_cond_signal</span><br><span class="line">     <span class="number">0.02</span>s  <span class="number">1.45</span>% <span class="number">96.38</span>%      <span class="number">0.02</span>s  <span class="number">1.45</span>%  runtime.walltime</span><br><span class="line">     <span class="number">0.02</span>s  <span class="number">1.45</span>% <span class="number">97.83</span>%      <span class="number">0.02</span>s  <span class="number">1.45</span>%  runtime.write1</span><br><span class="line">     <span class="number">0.01</span>s  <span class="number">0.72</span>% <span class="number">98.55</span>%      <span class="number">0.01</span>s  <span class="number">0.72</span>%  log.itoa</span><br><span class="line">     <span class="number">0.01</span>s  <span class="number">0.72</span>% <span class="number">99.28</span>%      <span class="number">0.01</span>s  <span class="number">0.72</span>%  runtime.(*mcache).prepareForSweep</span><br><span class="line">     <span class="number">0.01</span>s  <span class="number">0.72</span>%   <span class="number">100</span>%      <span class="number">0.01</span>s  <span class="number">0.72</span>%  runtime.memmove</span><br></pre></td></tr></table></figure>

<ul>
<li>flat：函数自身的运行耗时。</li>
<li>flat%：函数自身在 CPU 运行耗时总比例。</li>
<li>sum%：函数自身累积使用 CPU 总比例。</li>
<li>cum：函数自身及其调用函数的运行总耗时。</li>
<li>cum%：函数自身及其调用函数的运行耗时总比例。</li>
<li>Name：函数名。</li>
</ul>
<p>在大多数的情况下，我们可以通过这五列得出一个应用程序的运行情况，知道当前是什么函数，正在做什么事情，占用了多少资源，谁又是占用资源的大头，以此来得到一个初步的分析方向。</p>
<blockquote>
<p>另外在交互命令行中，pprof 还支持了大量的其它命令，具体可执行 pprof help 查看帮助说明。</p>
</blockquote>
<h4 id="Heap-Profiling"><a href="#Heap-Profiling" class="headerlink" title="Heap Profiling"></a>Heap Profiling</h4><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">$ <span class="keyword">go</span> tool pprof http:<span class="comment">//localhost:8080/debug/pprof/heap</span></span><br><span class="line">Fetching profile over HTTP from http:<span class="comment">//localhost:8080/debug/pprof/heap</span></span><br><span class="line">Saved profile in /Users/lizhewei/pprof/pprof.alloc_objects.alloc_space.inuse_objects.inuse_space<span class="number">.001</span>.pb.gz</span><br><span class="line">Type: inuse_space</span><br><span class="line">Time: Dec <span class="number">15</span>, <span class="number">2021</span> at <span class="number">4</span>:<span class="number">56</span>pm (CST)</span><br><span class="line">Entering interactive mode (<span class="keyword">type</span> <span class="string">&quot;help&quot;</span> <span class="keyword">for</span> commands, <span class="string">&quot;o&quot;</span> <span class="keyword">for</span> options)</span><br><span class="line">(pprof) </span><br></pre></td></tr></table></figure>

<p>执行该命令后，能够很快的拉取到其结果，因为它不需要像 CPU Profiling 做采样等待，这里需要注意的一点是 <code>Type</code> 这一个选项，你可以看到它默认显示的是 <code>inuse_space</code>，实际上可以针对多种内存概况进行分析，常用的类别如下：</p>
<p>一共有四种类型：</p>
<ol>
<li><strong>inuse_space</strong>：分析应用程序的常驻内存占用情况。</li>
<li><strong>alloc_objects</strong>：分析应用程序的内存临时分配情况。</li>
<li><strong>inuse_objects</strong>：查看每个函数所分别的对象数量。</li>
<li><strong>alloc_space</strong>：查看分配的内存空间大小。</li>
</ol>
<ul>
<li>inuse_space：分析应用程序的常驻内存占用情况。</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">$  <span class="keyword">go</span> tool pprof -inuse_space http:<span class="comment">//localhost:8080/debug/pprof/heap</span></span><br><span class="line">Fetching profile over HTTP from http:<span class="comment">//localhost:8080/debug/pprof/heap</span></span><br><span class="line">Saved profile in /Users/lizhewei/pprof/pprof.alloc_objects.alloc_space.inuse_objects.inuse_space<span class="number">.002</span>.pb.gz</span><br><span class="line">Type: inuse_space</span><br><span class="line">Time: Dec <span class="number">15</span>, <span class="number">2021</span> at <span class="number">4</span>:<span class="number">59</span>pm (CST)</span><br><span class="line">Entering interactive mode (<span class="keyword">type</span> <span class="string">&quot;help&quot;</span> <span class="keyword">for</span> commands, <span class="string">&quot;o&quot;</span> <span class="keyword">for</span> options)</span><br><span class="line">(pprof) top</span><br><span class="line">Showing nodes accounting <span class="keyword">for</span> <span class="number">4130.49</span>kB, <span class="number">100</span>% of <span class="number">4130.49</span>kB total</span><br><span class="line">Showing top <span class="number">10</span> nodes out of <span class="number">20</span></span><br><span class="line">      flat  flat%   sum%        cum   cum%</span><br><span class="line"> <span class="number">1567.04</span>kB <span class="number">37.94</span>% <span class="number">37.94</span>%  <span class="number">1567.04</span>kB <span class="number">37.94</span>%  main.Add (inline)</span><br><span class="line"> <span class="number">1537.69</span>kB <span class="number">37.23</span>% <span class="number">75.17</span>%  <span class="number">1537.69</span>kB <span class="number">37.23</span>%  runtime.allocm</span><br><span class="line">  <span class="number">513.56</span>kB <span class="number">12.43</span>% <span class="number">87.60</span>%   <span class="number">513.56</span>kB <span class="number">12.43</span>%  regexp/syntax.init</span><br><span class="line">  <span class="number">512.20</span>kB <span class="number">12.40</span>%   <span class="number">100</span>%   <span class="number">512.20</span>kB <span class="number">12.40</span>%  runtime.malg</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%  <span class="number">1567.04</span>kB <span class="number">37.94</span>%  main.main.func1</span><br></pre></td></tr></table></figure>

<ul>
<li>alloc_objects：分析应用程序的内存临时分配情况。</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">$ <span class="keyword">go</span> tool pprof -alloc_objects http:<span class="comment">//localhost:8080/debug/pprof/heap</span></span><br><span class="line">Fetching profile over HTTP from http:<span class="comment">//localhost:8080/debug/pprof/heap</span></span><br><span class="line">Saved profile in /Users/lizhewei/pprof/pprof.alloc_objects.alloc_space.inuse_objects.inuse_space<span class="number">.003</span>.pb.gz</span><br><span class="line">Type: alloc_objects</span><br><span class="line">Time: Dec <span class="number">15</span>, <span class="number">2021</span> at <span class="number">5</span>:<span class="number">01</span>pm (CST)</span><br><span class="line">Entering interactive mode (<span class="keyword">type</span> <span class="string">&quot;help&quot;</span> <span class="keyword">for</span> commands, <span class="string">&quot;o&quot;</span> <span class="keyword">for</span> options)</span><br><span class="line">(pprof) top</span><br><span class="line">Showing nodes accounting <span class="keyword">for</span> <span class="number">311313</span>, <span class="number">99.07</span>% of <span class="number">314251</span> total</span><br><span class="line">Dropped <span class="number">39</span> nodes (cum &lt;= <span class="number">1571</span>)</span><br><span class="line">      flat  flat%   sum%        cum   cum%</span><br><span class="line">    <span class="number">163842</span> <span class="number">52.14</span>% <span class="number">52.14</span>%     <span class="number">311313</span> <span class="number">99.07</span>%  main.main.func1</span><br><span class="line">    <span class="number">131074</span> <span class="number">41.71</span>% <span class="number">93.85</span>%     <span class="number">131074</span> <span class="number">41.71</span>%  fmt.Sprintf</span><br><span class="line">     <span class="number">16397</span>  <span class="number">5.22</span>% <span class="number">99.07</span>%      <span class="number">16397</span>  <span class="number">5.22</span>%  main.Add (inline)</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>% <span class="number">99.07</span>%     <span class="number">131074</span> <span class="number">41.71</span>%  log.Printf</span><br></pre></td></tr></table></figure>

<p>另外还有 inuse_objects 和 alloc_space 类别，分别对应查看每个函数所分别的对象数量和查看分配的内存空间大小，具体可根据情况选用。</p>
<h4 id="Goroutine-Profiling"><a href="#Goroutine-Profiling" class="headerlink" title="Goroutine Profiling"></a>Goroutine Profiling</h4><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">$ <span class="keyword">go</span> tool pprof http:<span class="comment">//localhost:8080/debug/pprof/goroutine</span></span><br><span class="line">Fetching profile over HTTP from http:<span class="comment">//localhost:8080/debug/pprof/goroutine</span></span><br><span class="line">Saved profile in /Users/lizhewei/pprof/pprof.goroutine<span class="number">.001</span>.pb.gz</span><br><span class="line">Type: goroutine</span><br><span class="line">Time: Dec <span class="number">15</span>, <span class="number">2021</span> at <span class="number">5</span>:<span class="number">04</span>pm (CST)</span><br><span class="line">Entering interactive mode (<span class="keyword">type</span> <span class="string">&quot;help&quot;</span> <span class="keyword">for</span> commands, <span class="string">&quot;o&quot;</span> <span class="keyword">for</span> options)</span><br><span class="line">(pprof) </span><br></pre></td></tr></table></figure>

<p>在查看 goroutine 时，我们可以使用 traces 命令，这个命令会打印出对应的所有调用栈，以及指标信息，可以让我们很便捷的查看到整个调用链路有什么，分别在哪里使用了多少个 goroutine，并且能够通过分析查看到谁才是真正的调用方，输出结果如下：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">(pprof) traces</span><br><span class="line">Type: goroutine</span><br><span class="line">-----------+-------------------------------------------------------</span><br><span class="line">         <span class="number">2</span>   runtime.gopark</span><br><span class="line">             runtime.netpollblock</span><br><span class="line">             internal/poll.runtime_pollWait</span><br><span class="line">             ...</span><br><span class="line">-----------+-------------------------------------------------------</span><br><span class="line">         <span class="number">1</span>   runtime.gopark</span><br><span class="line">             runtime.netpollblock</span><br><span class="line">             ...</span><br><span class="line">             net/http.ListenAndServe</span><br><span class="line">             main.main</span><br><span class="line">             runtime.main</span><br></pre></td></tr></table></figure>

<p>在调用栈上来讲，其展示顺序是<strong>自下而上</strong>的，也就是 <code>runtime.main</code> 方法调用了 <code>main.main</code> 方法，<code>main.main</code> 方法又调用了 <code>net/http.ListenAndServe</code> 方法，这里对应的也就是我们所使用的示例代码了，排查起来会非常方便。</p>
<p>每个调用堆栈信息用 <code>-----------</code> 分割，函数方法前的就是指标数据，像 Goroutine Profiling 展示是就是该方法占用的 goroutine 的数量。而 Heap Profiling 展示的就是占用的内存大小，如下：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">$ <span class="keyword">go</span> tool pprof http:<span class="comment">//localhost:8080/debug/pprof/heap</span></span><br><span class="line">...</span><br><span class="line">Type: inuse_space</span><br><span class="line">Entering interactive mode (<span class="keyword">type</span> <span class="string">&quot;help&quot;</span> <span class="keyword">for</span> commands, <span class="string">&quot;o&quot;</span> <span class="keyword">for</span> options)</span><br><span class="line">(pprof) traces</span><br><span class="line">Type: inuse_space</span><br><span class="line">-----------+-------------------------------------------------------</span><br><span class="line">     bytes:  <span class="number">13.55</span>MB</span><br><span class="line">   <span class="number">13.55</span>MB   main.Add</span><br><span class="line">             main.main.func1</span><br><span class="line">-----------+-------------------------------------------------------</span><br></pre></td></tr></table></figure>

<h4 id="Mutex-Profiling"><a href="#Mutex-Profiling" class="headerlink" title="Mutex Profiling"></a>Mutex Profiling</h4><p>怎么样的情况下会造成阻塞呢，一般有如下方式：调用 chan（通道）、调用 <code>sync.Mutex</code> （同步锁）、调用 <code>time.Sleep()</code> 等等。那么为了验证互斥锁的竞争持有者的堆栈跟踪，我们可以根据以上的 <code>sync.Mutex</code> 方式，来调整先前的示例代码，代码如下：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line"> runtime.SetMutexProfileFraction(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"> <span class="keyword">var</span> m sync.Mutex</span><br><span class="line"> <span class="keyword">var</span> datas = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">int</span>]<span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line"> <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">999</span>; i++ &#123;</span><br><span class="line">  <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">   m.Lock()</span><br><span class="line">   <span class="keyword">defer</span> m.Unlock()</span><br><span class="line">   datas[i] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">  &#125;(i)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> _ = http.ListenAndServe(<span class="string">&quot;:6061&quot;</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要特别注意的是 <code>runtime.SetMutexProfileFraction</code> 语句，如果未来希望进行互斥锁的采集，那么需要通过调用该方法来设置采集频率，若不设置或没有设置大于 0 的数值，默认是不进行采集的。</p>
<p>接下来我们进行调用 <code>go tool pprof</code> 进行分析，如下：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">$ <span class="keyword">go</span> tool pprof http:<span class="comment">//localhost:8081/debug/pprof/mutex</span></span><br><span class="line">Fetching profile over HTTP from http:<span class="comment">//localhost:8081/debug/pprof/mutex</span></span><br><span class="line">Saved profile in /Users/lizhewei/pprof/pprof.contentions.delay<span class="number">.002</span>.pb.gz</span><br><span class="line">Type: delay</span><br><span class="line">Time: Dec <span class="number">15</span>, <span class="number">2021</span> at <span class="number">5</span>:<span class="number">18</span>pm (CST)</span><br><span class="line">Entering interactive mode (<span class="keyword">type</span> <span class="string">&quot;help&quot;</span> <span class="keyword">for</span> commands, <span class="string">&quot;o&quot;</span> <span class="keyword">for</span> options)</span><br><span class="line">(pprof) </span><br></pre></td></tr></table></figure>

<p>我们查看调用 top 命令，查看互斥量的排名：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">(pprof) top</span><br><span class="line">Showing nodes accounting <span class="keyword">for</span> <span class="number">1.77</span>ms, <span class="number">100</span>% of <span class="number">1.77</span>ms total</span><br><span class="line">      flat  flat%   sum%        cum   cum%</span><br><span class="line">    <span class="number">1.77</span>ms   <span class="number">100</span>%   <span class="number">100</span>%     <span class="number">1.77</span>ms   <span class="number">100</span>%  sync.(*Mutex).Unlock</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%     <span class="number">1.77</span>ms   <span class="number">100</span>%  main.main.func1</span><br></pre></td></tr></table></figure>

<p>接下来我们可以调用 list 命令，看到指定函数的代码情况（包含特定的指标信息，例如：耗时），若函数名不明确，默认会对函数名进行模糊匹配，如下：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">(pprof) list main</span><br><span class="line">Total: <span class="number">1.77</span>ms</span><br><span class="line">ROUTINE ======================== main.main.func1 in /Volumes/D/<span class="keyword">go</span>/src/github.com/lizw91/pprof/main.<span class="keyword">go</span></span><br><span class="line">         <span class="number">0</span>     <span class="number">1.77</span>ms (flat, cum)   <span class="number">100</span>% of Total</span><br><span class="line">         .          .     <span class="number">17</span>:   <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ &#123;</span><br><span class="line">         .          .     <span class="number">18</span>:           <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">         .          .     <span class="number">19</span>:                   m.Lock()</span><br><span class="line">         .          .     <span class="number">20</span>:                   <span class="keyword">defer</span> m.Unlock()</span><br><span class="line">         .          .     <span class="number">21</span>:                   datas[i] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">         .     <span class="number">1.77</span>ms     <span class="number">22</span>:           &#125;(i)</span><br><span class="line">         .          .     <span class="number">23</span>:   &#125;</span><br><span class="line">         .          .     <span class="number">24</span>:</span><br><span class="line">         .          .     <span class="number">25</span>:   _ = http.ListenAndServe(<span class="string">&quot;:8081&quot;</span>, <span class="literal">nil</span>)</span><br><span class="line">         .          .     <span class="number">26</span>:&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以在输出的分析中比较准确的看到引起互斥锁的函数在哪里，锁开销在哪里，在本例中是第 22 行。</p>
<h4 id="Block-Profiling"><a href="#Block-Profiling" class="headerlink" title="Block Profiling"></a>Block Profiling</h4><p>与 Mutex 的 <code>runtime.SetMutexProfileFraction</code> 相似，Block 也需要调用 <code>runtime.SetBlockProfileRate()</code> 进行采集量的设置，否则默认关闭，若设置的值小于等于 0 也会认为是关闭。</p>
<p>与上小节 Mutex 相比，主体代码不变，仅是新增 <code>runtime.SetBlockProfileRate()</code>的调用，如下：</p>
<p><strong>示例代码</strong> </p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	_ <span class="string">&quot;net/http/pprof&quot;</span></span><br><span class="line">	<span class="string">&quot;runtime&quot;</span></span><br><span class="line">	<span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	runtime.SetBlockProfileRate(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> m sync.Mutex</span><br><span class="line">	<span class="keyword">var</span> datas = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">int</span>]<span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ &#123;</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">			m.Lock()</span><br><span class="line">			<span class="keyword">defer</span> m.Unlock()</span><br><span class="line">			datas[i] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">		&#125;(i)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	_ = http.ListenAndServe(<span class="string">&quot;:8081&quot;</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们查看调用 top 命令，查看阻塞情况的排名：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">$ <span class="keyword">go</span> tool pprof http:<span class="comment">//localhost:8081/debug/pprof/block</span></span><br><span class="line">Fetching profile over HTTP from http:<span class="comment">//localhost:8081/debug/pprof/block</span></span><br><span class="line">Saved profile in /Users/lizhewei/pprof/pprof.contentions.delay<span class="number">.003</span>.pb.gz</span><br><span class="line">Type: delay</span><br><span class="line">Time: Dec <span class="number">15</span>, <span class="number">2021</span> at <span class="number">5</span>:<span class="number">21</span>pm (CST)</span><br><span class="line">Entering interactive mode (<span class="keyword">type</span> <span class="string">&quot;help&quot;</span> <span class="keyword">for</span> commands, <span class="string">&quot;o&quot;</span> <span class="keyword">for</span> options)</span><br><span class="line">(pprof) top</span><br><span class="line">Showing nodes accounting <span class="keyword">for</span> <span class="number">48.97</span>ms, <span class="number">100</span>% of <span class="number">48.97</span>ms total</span><br><span class="line">      flat  flat%   sum%        cum   cum%</span><br><span class="line">   <span class="number">48.97</span>ms   <span class="number">100</span>%   <span class="number">100</span>%    <span class="number">48.97</span>ms   <span class="number">100</span>%  sync.(*Mutex).Lock (inline)</span><br><span class="line">         <span class="number">0</span>     <span class="number">0</span>%   <span class="number">100</span>%    <span class="number">48.97</span>ms   <span class="number">100</span>%  main.main.func1</span><br></pre></td></tr></table></figure>

<p>同样的，我们也可以调用 list 命令查看具体的阻塞情况，执行方式和排查模式与先前概述的一致。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">(pprof) list main</span><br><span class="line">Total: <span class="number">48.97</span>ms</span><br><span class="line">ROUTINE ======================== main.main.func1 in /Volumes/D/<span class="keyword">go</span>/src/github.com/lizw91/pprof/main.<span class="keyword">go</span></span><br><span class="line">         <span class="number">0</span>    <span class="number">48.97</span>ms (flat, cum)   <span class="number">100</span>% of Total</span><br><span class="line">         .          .     <span class="number">14</span>:<span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">         .          .     <span class="number">15</span>:   <span class="keyword">var</span> m sync.Mutex</span><br><span class="line">         .          .     <span class="number">16</span>:   <span class="keyword">var</span> datas = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">int</span>]<span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">         .          .     <span class="number">17</span>:   <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ &#123;</span><br><span class="line">         .          .     <span class="number">18</span>:           <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">         .    <span class="number">48.97</span>ms     <span class="number">19</span>:                   m.Lock()</span><br><span class="line">         .          .     <span class="number">20</span>:                   <span class="keyword">defer</span> m.Unlock()</span><br><span class="line">         .          .     <span class="number">21</span>:                   datas[i] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">         .          .     <span class="number">22</span>:           &#125;(i)</span><br><span class="line">         .          .     <span class="number">23</span>:   &#125;</span><br><span class="line">         .          .     <span class="number">24</span>:</span><br></pre></td></tr></table></figure>

<h3 id="查看可视化界面"><a href="#查看可视化界面" class="headerlink" title="查看可视化界面"></a>查看可视化界面</h3><p>接下来我们继续使用前面的示例程序，将其重新运行起来，然后在其它窗口执行下述命令：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 获取 cpu 指标</span></span><br><span class="line">$ wget -O cpu.profile http:<span class="comment">//127.0.0.1:8080/debug/pprof/profile?seconds=30</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取 heap 指标 </span></span><br><span class="line">$ wget -O mem.profile http:<span class="comment">//127.0.0.1:8080/debug/pprof/profile?seconds=30</span></span><br></pre></td></tr></table></figure>

<p>默认需要等待 30 秒，执行完毕后可在当前目录下发现采集的文件 cpu.profile，针对可视化界面我们有两种方式可进行下一步分析：</p>
<ol>
<li>方法一<strong>（推荐）</strong>：该命令将在所指定的端口号运行一个 pprof 的分析用的站点</li>
</ol>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">$ <span class="keyword">go</span> tool pprof -http=:<span class="number">8081</span> cpu.profile  </span><br></pre></td></tr></table></figure>

<ol>
<li>方法二：通过 web 命令将以 svg 的文件格式写入图形，然后在 Web 浏览器中将其打开。</li>
</ol>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">$ <span class="keyword">go</span> tool pprof cpu.profile</span><br><span class="line">Type: cpu</span><br><span class="line">Time: Feb <span class="number">1</span>, <span class="number">2020</span> at <span class="number">12</span>:<span class="number">09</span>pm (CST)</span><br><span class="line">Duration: <span class="number">30</span>s, Total samples = <span class="number">60</span>ms (  <span class="number">0.2</span>%)</span><br><span class="line">Entering interactive mode (<span class="keyword">type</span> <span class="string">&quot;help&quot;</span> <span class="keyword">for</span> commands, <span class="string">&quot;o&quot;</span> <span class="keyword">for</span> options)</span><br><span class="line">(pprof) web</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果出现错误提示 Could not execute dot; may need to install graphviz.，那么意味着你需要安装 graphviz组件。</p>
<p>另外方法一所运行的站点，实际上包含了方法二的内容（svg图片），并且更灵活，因此非特殊情况，我们会直接使用方法一的方式运行站点来做观察和分析。</p>
</blockquote>
<p>通过 pprof 所提供的可视化界面，我们能够更方便、更直观的看到 Go 应用程序的调用链、使用情况等。</p>
<p>另外在 View 菜单栏中，PProf 还支持多种分析方式的切换，如下：</p>
<img src="/2022/11/28/56/1639561832030-18ced959-237a-4a72-9121-a05850d0e4b9.png" class="" title="img">

<p>view 菜单栏</p>
<p>接下来我们将基于 CPU Profiling 所抓取的 Profile 进行一一介绍，而其它 Profile 类型的分析模式也是互通的，只要我们了解了一种，其余的也就会了。</p>
<h4 id="Top"><a href="#Top" class="headerlink" title="Top"></a>Top</h4><img src="/2022/11/28/56/1639561878713-40879f4c-8c9b-429d-bff5-bcfdffc32fc1.png" class="" title="img">

<ul>
<li>flat：函数自身的运行耗时。</li>
<li>flat%：函数自身在 CPU 运行耗时总比例。</li>
<li>sum%：函数自身累积使用 CPU 总比例。</li>
<li>cum：函数自身及其调用函数的运行总耗时。</li>
<li>cum%：函数自身及其调用函数的运行耗时总比例。</li>
<li>Name：函数名。</li>
</ul>
<h4 id="Graph"><a href="#Graph" class="headerlink" title="Graph"></a>Graph</h4><img src="/2022/11/28/56/1639561986430-2a11499e-5106-4273-8ce7-85caacd60ac0.png" class="" title="img">





<p>该视图展示的为整体的函数调用流程，框越大、线越粗、框颜色越鲜艳（红色）就代表它占用的时间越久，开销越大。相反若框颜色越淡，越小则代表在整体的函数调用流程中，它的开销是相对较小的。因此我们可以用此视图去分析谁才是开销大头，它又是因为什么调用流程而被调用的。</p>
<h4 id="Peek"><a href="#Peek" class="headerlink" title="Peek"></a>Peek</h4><img src="/2022/11/28/56/1639562053535-d85c624d-78ca-4460-93a2-d46fdb060ca1.png" class="" title="img">



<p>peek 栏目，此视图相较于 Top 视图，增加了所属的上下文信息的展示，也就是函数的输出调用者/被调用者。</p>
<h4 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h4><img src="/2022/11/28/56/1639562087329-46ed34bf-0b80-4510-bc2c-9dbf5b34a0da.png" class="" title="img">

<p>source 栏目，该视图主要是增加了面向源代码的追踪和分析，可以看到其开销主要消耗在哪里。</p>
<h4 id="flame-graph"><a href="#flame-graph" class="headerlink" title="flame graph"></a>flame graph</h4><img src="/2022/11/28/56/1639568828478-ad6f5933-8572-4dbd-b73d-f637ba70a610-20221128223022437.png" class="" title="image.png">

<p>Flame Graph（火焰图）它是可动态的，调用顺序由上到下（A -&gt; B -&gt; C -&gt; D），每一块代表一个函数、颜色越鲜艳（红）、区块越大代表占用 CPU 的时间更长。同时它也支持点击块深入进行分析。</p>
<p>我们选择页面上的 main.main.func1 区块，将会进入到其属下的下一层级，如下：</p>
<img src="/2022/11/28/56/1639568868468-031d2b33-b044-4827-a283-5bd689ab07d3-20221128223104007.png" class="" title="image.png">

<p>进一步查看 flame graph，这样子我们就可以根据不同函数的多维度层级进行分析，能够更好的观察其流转并发现问题。</p>
<h1 id="工具型应用"><a href="#工具型应用" class="headerlink" title="工具型应用"></a>工具型应用</h1><p>如果你的应用程序是运行一段时间就结束退出类型。那么最好的办法是在应用退出的时候把 profiling 的报告保存到文件中，进行分析。对于这种情况，可以使用<code>runtime/pprof</code>库。 首先在代码中导入<code>runtime/pprof</code>工具：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;runtime/pprof&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="CPU性能分析"><a href="#CPU性能分析" class="headerlink" title="CPU性能分析"></a>CPU性能分析</h2><p>开启CPU性能分析：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">pprof.StartCPUProfile(w io.Writer) </span><br></pre></td></tr></table></figure>

<p>停止CPU性能分析：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">pprof.StopCPUProfile() </span><br></pre></td></tr></table></figure>

<p>应用执行结束后，就会生成一个文件，保存了我们的 CPU profiling 数据。得到采样数据之后，使用 <code>go tool pprof</code>工具进行 CPU 性能分析。</p>
<h2 id="内存性能优化"><a href="#内存性能优化" class="headerlink" title="内存性能优化"></a>内存性能优化</h2><p>记录程序的堆栈信息</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">pprof.WriteHeapProfile(w io.Writer)</span><br></pre></td></tr></table></figure>

<p><code>go tool pprof</code>默认是使用<code>-inuse_space</code> 进行统计，还可以使用 <code>-inuse-objects</code> 查看分配对象的数量。</p>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// runtime_pprof/main.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;flag&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;runtime/pprof&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 一段有问题的代码</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">logicCode</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> c <span class="keyword">chan</span> <span class="type">int</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> v := &lt;-c:</span><br><span class="line">			fmt.Printf(<span class="string">&quot;recv from chan, value:%v\n&quot;</span>, v)</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> isCPUPprof <span class="type">bool</span></span><br><span class="line">	<span class="keyword">var</span> isMemPprof <span class="type">bool</span></span><br><span class="line"></span><br><span class="line">	flag.BoolVar(&amp;isCPUPprof, <span class="string">&quot;cpu&quot;</span>, <span class="literal">false</span>, <span class="string">&quot;turn cpu pprof on&quot;</span>)</span><br><span class="line">	flag.BoolVar(&amp;isMemPprof, <span class="string">&quot;mem&quot;</span>, <span class="literal">false</span>, <span class="string">&quot;turn mem pprof on&quot;</span>)</span><br><span class="line">	flag.Parse()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> isCPUPprof &#123;</span><br><span class="line">		file, err := os.Create(<span class="string">&quot;./cpu.pprof&quot;</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">&quot;create cpu pprof failed, err:%v\n&quot;</span>, err)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		pprof.StartCPUProfile(file)</span><br><span class="line">		<span class="keyword">defer</span> pprof.StopCPUProfile()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">8</span>; i++ &#123;</span><br><span class="line">		<span class="keyword">go</span> logicCode()</span><br><span class="line">	&#125;</span><br><span class="line">	time.Sleep(<span class="number">20</span> * time.Second)</span><br><span class="line">	<span class="keyword">if</span> isMemPprof &#123;</span><br><span class="line">		file, err := os.Create(<span class="string">&quot;./mem.pprof&quot;</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">&quot;create mem pprof failed, err:%v\n&quot;</span>, err)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		pprof.WriteHeapProfile(file)</span><br><span class="line">		file.Close()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过flag我们可以在命令行控制是否开启 CPU和  Mem 的性能分析。 将上面的代码保存并编译成runtime_pprof 可执行文件，执行时加上 -cpu 命令行参数如下：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">go</span> run main.<span class="keyword">go</span> -cpu</span><br></pre></td></tr></table></figure>

<p>等待30秒后会在当前目录下生成一个 cpu.pprof 文件。然后，执行<code>go tool pprof</code>命令就可以查看</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">$ <span class="keyword">go</span> tool pprof cpu.pprof</span><br><span class="line">Type: cpu</span><br><span class="line">Time: Dec <span class="number">15</span>, <span class="number">2021</span> at <span class="number">8</span>:<span class="number">25</span>pm (CST)</span><br><span class="line">Duration: <span class="number">20.19</span>s, Total samples = <span class="number">119.64</span>s (<span class="number">592.65</span>%)</span><br><span class="line">Entering interactive mode (<span class="keyword">type</span> <span class="string">&quot;help&quot;</span> <span class="keyword">for</span> commands, <span class="string">&quot;o&quot;</span> <span class="keyword">for</span> options)</span><br><span class="line">(pprof) top</span><br><span class="line">Showing nodes accounting <span class="keyword">for</span> <span class="number">119.62</span>s, <span class="number">100</span>% of <span class="number">119.64</span>s total</span><br><span class="line">Dropped <span class="number">2</span> nodes (cum &lt;= <span class="number">0.60</span>s)</span><br><span class="line">      flat  flat%   sum%        cum   cum%</span><br><span class="line">    <span class="number">52.65</span>s <span class="number">44.01</span>% <span class="number">44.01</span>%     <span class="number">52.65</span>s <span class="number">44.01</span>%  runtime.chanrecv</span><br><span class="line">    <span class="number">51.04</span>s <span class="number">42.66</span>% <span class="number">86.67</span>%    <span class="number">103.69</span>s <span class="number">86.67</span>%  runtime.selectnbrecv</span><br><span class="line">    <span class="number">15.93</span>s <span class="number">13.31</span>%   <span class="number">100</span>%    <span class="number">119.63</span>s   <span class="number">100</span>%  main.logicCode</span><br></pre></td></tr></table></figure>

<h1 id="压测工具wrk"><a href="#压测工具wrk" class="headerlink" title="压测工具wrk"></a>压测工具wrk</h1><p>推荐使用：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/wg/wrk">https://github.com/wg/wrk</a> </p>
<p><a target="_blank" rel="noopener" href="https://github.com/adjust/go-wrk">https://github.com/adjust/go-wrk</a></p>
<p>使用wrk进行压测:</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">go</span>-wrk -n <span class="number">50000</span> http:<span class="comment">//127.0.0.1:8080/book/list</span></span><br></pre></td></tr></table></figure>

<p>在上面压测进行的同时，打开另一个终端执行:</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">$ <span class="keyword">go</span> tool pprof http:<span class="comment">//localhost:8080/debug/pprof/profile?seconds=60</span></span><br></pre></td></tr></table></figure>

<h1 id="pprof与性能测试结合"><a href="#pprof与性能测试结合" class="headerlink" title="pprof与性能测试结合"></a>pprof与性能测试结合</h1><p><code>go test</code> 命令有两个参数和 pprof 相关，它们分别指定生成的 CPU 和 Memory profiling 保存的文件：</p>
<ul>
<li>-cpuprofile：cpu profiling 数据要保存的文件地址</li>
<li>-memprofile：memory profiling 数据要报文的文件地址</li>
</ul>
<p>我们还可以选择将pprof与性能测试相结合，比如：</p>
<p>比如下面执行测试的同时，也会执行 CPU profiling，并把结果保存在 cpu.prof 文件中：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">go</span> test -bench . -cpuprofile=cpu.profile</span><br></pre></td></tr></table></figure>

<p>比如下面执行测试的同时，也会执行 Mem profiling，并把结果保存在 cpu.prof 文件中：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">go</span> test -bench . -memprofile=./mem.profile</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意：</strong> 获取的 Profiling 数据是动态的，要想获得有效的数据，请保证应用处于较大的负载（比如正在生成中运行的服务，或者通过其他工具模拟访问压力）。否则如果应用处于空闲状态，得到的结果可能没有任何意义。所以，<strong>Profiling 一般和性能测试一起使用</strong></p>
</blockquote>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="http://lizhewei91.github.io/2022/11/28/56/" title="性能剖析大杀器 pprof" target="_blank" rel="external">http://lizhewei91.github.io/2022/11/28/56/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/lizhewei91" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/lizhewei91" target="_blank"><span class="text-dark">李哲伟</span><small class="ml-1x">Cloud Natural Developer</small></a></h3>
        <div>专注于云原生领域。</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="vcomments"></div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2022/11/28/29/" title="hexo+typora图片插入"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    
    <li class="toggle-toc">
      <a class="toggle-btn " data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">    <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
    
  </div>
  </div>
</nav>
  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>感谢您的支持，我会继续努力的!</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">扫码打赏，你说多少就多少</p>
              <p class="text-grey">打开支付宝扫一扫，即可进行扫码打赏哦</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">扫码打赏，你说多少就多少</p>
              <p class="text-grey">打开微信扫一扫，即可进行扫码打赏哦</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/lizhewei91" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>



    <script>
(function ($) {
    $('.search-form').on('submit', function (e) {
        var keyword = $('.search-form-input[name="wd"]').val();
        window.location = 'https://www.baidu.com/s?wd=site:lizhewei91.github.io ' + keyword;
        return false;
    });
})(jQuery);
</script>




   




   
    
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/valine"></script>
  <script type="text/javascript">
  var GUEST = ['nick', 'mail', 'link'];
  var meta = 'nick,mail,link';
  meta = meta.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#vcomments',
    verify: false,
    notify: false,
    appId: '',
    appKey: '',
    placeholder: 'Just go go',
    avatar: 'mm',
    meta: meta,
    pageSize: '10' || 10,
    visitor: false
  });
  </script>

     







</body>
</html>