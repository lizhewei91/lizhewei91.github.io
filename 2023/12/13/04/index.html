<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>NVIDIA/gpu-operator分析: 原理解析 | lizhewei&#39;s Blog</title>
  <meta name="description" content="背景我们知道，如果在Kubernetes中支持GPU设备调度，需要做如下的工作：  节点上安装nvidia驱动 节点上安装nvidia-docker 集群部署gpu device plugin，用于为调度到该节点的pod分配GPU设备。  除此之外，如果你需要监控集群GPU资源使用情况，你可能还需要安装 DCGM exporter 结合 Prometheus 输出 GPU 资源监控信息。 要安装和">
<meta property="og:type" content="article">
<meta property="og:title" content="NVIDIA&#x2F;gpu-operator分析: 原理解析">
<meta property="og:url" content="http://lizhewei91.github.io/2023/12/13/04/index.html">
<meta property="og:site_name" content="lizhewei&#39;Blog">
<meta property="og:description" content="背景我们知道，如果在Kubernetes中支持GPU设备调度，需要做如下的工作：  节点上安装nvidia驱动 节点上安装nvidia-docker 集群部署gpu device plugin，用于为调度到该节点的pod分配GPU设备。  除此之外，如果你需要监控集群GPU资源使用情况，你可能还需要安装 DCGM exporter 结合 Prometheus 输出 GPU 资源监控信息。 要安装和">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://lizhewei91.github.io/2023/12/13/04/gpu-operator%E6%80%BB%E7%BB%93-2460579.png">
<meta property="og:image" content="http://lizhewei91.github.io/2023/12/13/04/cluster-policy-controller%E9%80%BB%E8%BE%91%E5%9B%BE-3040552.png">
<meta property="og:image" content="http://lizhewei91.github.io/2023/12/13/04/cluster-policy-controller.png">
<meta property="og:image" content="http://lizhewei91.github.io/2023/12/13/04/nvd-basics.svg">
<meta property="og:image" content="http://lizhewei91.github.io/2023/12/13/04/nvidia-driver-controller%E9%80%BB%E8%BE%91%E5%9B%BE.png">
<meta property="og:image" content="http://lizhewei91.github.io/2023/12/13/04/NVIDIADriver.png">
<meta property="og:image" content="http://lizhewei91.github.io/2023/12/13/04/upgrade-controller-state-machine.png">
<meta property="article:published_time" content="2023-12-13T08:31:04.000Z">
<meta property="article:modified_time" content="2023-12-20T04:14:38.548Z">
<meta property="article:author" content="lizhewei">
<meta property="article:tag" content="gpu-operator">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://lizhewei91.github.io/2023/12/13/04/gpu-operator%E6%80%BB%E7%BB%93-2460579.png">
  <!-- Canonical links -->
  <link rel="canonical" href="http://lizhewei91.github.io/2023/12/13/04/index.html">
  
    <link rel="alternate" href="/atom.xml" title="lizhewei&#39;Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 5.4.2"></head>


<body class="main-center" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/lizhewei91" target="_blank">
          <img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">李哲伟</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">Cloud Native Developer</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Beijing, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">标签</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">项目</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">关于</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/lizhewei91" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      
  <div class="widget">
    <h3 class="widget-title">分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/NUMA/">NUMA</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/device-plugins/">device-plugins</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/gin/">gin</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/gpu-operator/">gpu-operator</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/gpushare/">gpushare</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/k8s-swagger-ui/">k8s-swagger-ui</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/kube-scheduler/">kube-scheduler</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/kubeadm/">kubeadm</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/kubectl-%E6%8F%92%E4%BB%B6/">kubectl 插件</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/kubelet/">kubelet</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/nexus/">nexus</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/nvidia-time-slicing/">nvidia/time-slicing</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/operator/">operator</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/pprof/">pprof</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/reloader/">reloader</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/webhook/">webhook</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%83%A8%E7%BD%B2k8s%E9%9B%86%E7%BE%A4/">部署k8s集群</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%95%9C%E5%83%8F/">镜像</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签</h3>
    <div class="widget-body">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/NUMA/" rel="tag">NUMA</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/buildx/" rel="tag">buildx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/code-generator/" rel="tag">code-generator</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/configMap/" rel="tag">configMap</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/device-manager/" rel="tag">device-manager</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/device-plugins/" rel="tag">device-plugins</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker-repositories/" rel="tag">docker-repositories</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/extender/" rel="tag">extender</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gin/" rel="tag">gin</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang/" rel="tag">golang</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gpu/" rel="tag">gpu</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gpu-operator/" rel="tag">gpu-operator</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gpushare/" rel="tag">gpushare</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jwt/" rel="tag">jwt</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k8s-swagger-ui/" rel="tag">k8s-swagger-ui</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/krew/" rel="tag">krew</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kube-schduler/" rel="tag">kube-schduler</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kube-scheduler%E4%BD%BF%E7%94%A8/" rel="tag">kube-scheduler使用</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kube-scheduler%E6%89%A9%E5%B1%95/" rel="tag">kube-scheduler扩展</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubeadm/" rel="tag">kubeadm</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubebuilder/" rel="tag">kubebuilder</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubectl-plugins/" rel="tag">kubectl-plugins</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubelet/" rel="tag">kubelet</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubevirt-gpu-device-plugin/" rel="tag">kubevirt-gpu-device-plugin</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/manifest/" rel="tag">manifest</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/multiple-schedulers/" rel="tag">multiple-schedulers</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nexus/" rel="tag">nexus</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node-%E8%8A%82%E7%82%B9%E8%B5%84%E6%BA%90%E5%88%86%E9%85%8D/" rel="tag">node 节点资源分配</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nvidia/" rel="tag">nvidia</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nvidia-gpu-operator/" rel="tag">nvidia/gpu-operator</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nvidia-gpu-share/" rel="tag">nvidia/gpu-share</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nvidia-time-slicing/" rel="tag">nvidia/time-slicing</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/operator/" rel="tag">operator</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pprof/" rel="tag">pprof</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reloader/" rel="tag">reloader</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scheduler-extender/" rel="tag">scheduler-extender</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scheduler-framework/" rel="tag">scheduler-framework</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/secret/" rel="tag">secret</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webhook/" rel="tag">webhook</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="tag">中间件</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%88%9B%E5%BB%BApod%E6%B5%81%E7%A8%8B/" rel="tag">创建pod流程</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/" rel="tag">性能分析</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%83%A8%E7%BD%B2k8s%E9%9B%86%E7%BE%A4/" rel="tag">部署k8s集群</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">归档</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/08/">八月 2024</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">一月 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">十二月 2023</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/10/">十月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">九月 2023</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/08/">八月 2023</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">七月 2023</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">三月 2023</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">二月 2023</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">一月 2023</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">十一月 2022</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>


    
  </div>
</aside>

  
  
  <aside class="sidebar sidebar-toc collapse   in  " id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-number">1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.</span> <span class="toc-text">组件介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.</span> <span class="toc-text">源码介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E6%8F%90%E8%AF%B4%E6%98%8E"><span class="toc-number">3.1.</span> <span class="toc-text">前提说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NVIDIA-GPU-operator-%E7%9A%84-CRDs"><span class="toc-number">3.2.</span> <span class="toc-text">NVIDIA GPU operator 的 CRDs</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#clusterpolicies-nvidia-com"><span class="toc-number">3.2.1.</span> <span class="toc-text">clusterpolicies.nvidia.com</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nvidiadrivers-nvidia-com"><span class="toc-number">3.2.2.</span> <span class="toc-text">nvidiadrivers.nvidia.com</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nodefeatures-nfd-k8s-sigs-io"><span class="toc-number">3.2.3.</span> <span class="toc-text">nodefeatures.nfd.k8s-sigs.io</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nodefeaturerules-nfd-k8s-sigs-io"><span class="toc-number">3.2.4.</span> <span class="toc-text">nodefeaturerules.nfd.k8s-sigs.io</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ClusterPolicy-Controller-%E5%88%86%E6%9E%90"><span class="toc-number">3.3.</span> <span class="toc-text">ClusterPolicy-Controller 分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ClusterPolicy-Controller-%E9%80%BB%E8%BE%91%E5%9B%BE"><span class="toc-number">3.3.1.</span> <span class="toc-text">ClusterPolicy-Controller 逻辑图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ClusterPolicy-Controller-%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">3.3.2.</span> <span class="toc-text">ClusterPolicy-Controller 整体流程图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ClusterPolicy-Controller-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">3.3.3.</span> <span class="toc-text">ClusterPolicy-Controller 源码分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NVIDIADriver-Controller-%E5%88%86%E6%9E%90"><span class="toc-number">3.4.</span> <span class="toc-text">NVIDIADriver-Controller 分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ClusterPolicyCRD-%E4%B8%8E-NVIDIADriverCRD-%E5%AF%B9%E6%AF%94"><span class="toc-number">3.4.1.</span> <span class="toc-text">ClusterPolicyCRD 与 NVIDIADriverCRD  对比</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NVIDIADriver-Controller-%E9%80%BB%E8%BE%91%E5%9B%BE"><span class="toc-number">3.4.2.</span> <span class="toc-text">NVIDIADriver-Controller 逻辑图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NVIDIADriver-Controller-%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">3.4.3.</span> <span class="toc-text">NVIDIADriver-Controller 整体流程图</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Upgrade-Controller-%E5%88%86%E6%9E%90"><span class="toc-number">3.5.</span> <span class="toc-text">Upgrade-Controller 分析</span></a></li></ol></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-NVIDIA-gpu-operator分析-原理解析" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      NVIDIA/gpu-operator分析: 原理解析
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2023/12/13/04/" class="article-date">
	  <time datetime="2023-12-13T08:31:04.000Z" itemprop="datePublished">2023-12-13</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/gpu-operator/">gpu-operator</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link-link" href="/tags/gpu-operator/" rel="tag">gpu-operator</a>
  </span>


        

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2023/12/13/04/#comments" class="article-comment-link">评论</a></span>
        
	
		<span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 3.3k(字)</span>
	
	
		<span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长: 16(分)</span>
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>我们知道，如果在Kubernetes中支持GPU设备调度，需要做如下的工作：</p>
<ul>
<li>节点上安装nvidia驱动</li>
<li>节点上安装nvidia-docker</li>
<li>集群部署gpu device plugin，用于为调度到该节点的pod分配GPU设备。</li>
</ul>
<p>除此之外，如果你需要监控集群GPU资源使用情况，你可能还需要安装 <a target="_blank" rel="noopener" href="https://github.com/NVIDIA/dcgm-exporter">DCGM exporter</a> 结合 Prometheus 输出 GPU 资源监控信息。</p>
<p>要安装和管理这么多的组件，对于运维人员来说压力不小。基于此，NVIDIA开源了一款叫 <a target="_blank" rel="noopener" href="https://github.com/NVIDIA/gpu-operator">NVIDIA GPU Operator</a> 的工具，该工具基于 <a target="_blank" rel="noopener" href="https://github.com/operator-framework">Operator Framework</a> 实现，用于自动化管理上面我们提到的这些组件。</p>
<p>在之前的文章中，作者分别介绍了NVIDIA GPU Operator所涉及的每一个组件并且演示了如何手动部署这些组件，在本篇文章中将介绍详细介绍NVIDIA GPU Operator的工作原理。</p>
<h1 id="组件介绍"><a href="#组件介绍" class="headerlink" title="组件介绍"></a>组件介绍</h1><p>从前面的文章中，我们知道NVIDIA GPU Operator总共包含如下的几个组件：</p>
<img src="/2023/12/13/04/gpu-operator%E6%80%BB%E7%BB%93-2460579.png" class="" title="gpu-operator总结">

<ul>
<li><p><a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/node-feature-discovery"><strong>NFD(Node Feature Discovery)</strong></a>：用于给节点打上某些标签，这些标签包括cpu id、内核版本、操作系统版本等标签。</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://gitlab.com/nvidia/container-images/driver"><strong>NVIDIA Driver</strong></a>：基于容器的方式在节点上安装NVIDIA GPU驱动，在k8s集群中以DaemonSet方式部署，只有节点拥有标签“nvidia.com/gpu.present=true”时，DaemonSet控制的Pod才会在该节点上运行。</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/NVIDIA/nvidia-container-toolkit"><strong>NVIDIA Container Toolkit</strong></a>：能够实现在容器中使用GPU设备，在k8s集群中以DaemonSet方式部署，只有节点拥有标签“nvidia.com/gpu.present=true”时，DaemonSet控制的Pod才会在该节点上运行。</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/NVIDIA/k8s-device-plugin"><strong>NVIDIA Device Plugin</strong></a>：NVIDIA Device Plugin用于实现将GPU设备以Kubernetes扩展资源的方式供用户使用，在k8s集群中以DaemonSet方式部署，只有节点拥有标签“nvidia.com/gpu.present=true”时，DaemonSet控制的Pod才会在该节点上运行。</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/NVIDIA/dcgm-exporter"><strong>DCGM Exporter</strong></a>：周期性的收集节点GPU设备的状态（当前温度、总的显存、已使用显存、使用率等），然后结合Prometheus和Grafana将这些指标用丰富的仪表盘展示给用户。在k8s集群中以DaemonSet方式部署，只有节点拥有标签“nvidia.com/gpu.present=true”时，DaemonSet控制的Pod才会在该节点上运行。</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/NVIDIA/gpu-feature-discovery"><strong>GFD(GPU Feature Discovery)</strong></a>：用于收集节点的GPU设备属性（GPU驱动版本、GPU型号等），并将这些属性以节点标签的方式透出。在k8s集群中以DaemonSet方式部署，只有节点拥有标签“nvidia.com/gpu.present=true”时，DaemonSet控制的Pod才会在该节点上运行。</p>
</li>
</ul>
<ul>
<li><strong>NVIDIA MIG Manager</strong>：</li>
</ul>
<h1 id="源码介绍"><a href="#源码介绍" class="headerlink" title="源码介绍"></a>源码介绍</h1><h2 id="前提说明"><a href="#前提说明" class="headerlink" title="前提说明"></a>前提说明</h2><ul>
<li><p>gpu-operator 的代码地址：<a target="_blank" rel="noopener" href="https://github.com/NVIDIA/gpu-operator/tree/v23.9.0">https://github.com/NVIDIA/gpu-operator/tree/v23.9.0</a></p>
</li>
<li><p>本文分析的 tag 分支：v23.9.0</p>
</li>
</ul>
<h2 id="NVIDIA-GPU-operator-的-CRDs"><a href="#NVIDIA-GPU-operator-的-CRDs" class="headerlink" title="NVIDIA GPU operator 的 CRDs"></a>NVIDIA GPU operator 的 CRDs</h2><p>当我们使用 helm install 部署 gpu-operator 时，默认会部署 4 个 CRDs资源：</p>
<h3 id="clusterpolicies-nvidia-com"><a href="#clusterpolicies-nvidia-com" class="headerlink" title="clusterpolicies.nvidia.com"></a>clusterpolicies.nvidia.com</h3><p>保存 gpu-operator 需要部署组件的配置信息。helm install 执行同时会创建 cluster-policy 的CR，可以通过kubectl 命令获取：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">clusterpolicies.nvidia.com</span> <span class="string">cluster-policy</span> <span class="string">-o</span> <span class="string">yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">nvidia.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2023-12-11T07:05:26Z&quot;</span></span><br><span class="line">  <span class="attr">generation:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">gpu-operator</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">release-name</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">Helm</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">gpu-operator</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="string">v23.9.0</span></span><br><span class="line">    <span class="attr">helm.sh/chart:</span> <span class="string">gpu-operator-v23.9.0</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-policy</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;5277388&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">345a5fd4-4549-4605-8fee-880fee68f40e</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ccManager:</span></span><br><span class="line">    <span class="attr">defaultMode:</span> <span class="string">&quot;off&quot;</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">env:</span> []</span><br><span class="line">    <span class="attr">image:</span> <span class="string">k8s-cc-manager</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">nvcr.io/nvidia/cloud-native</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v0.1.1</span></span><br><span class="line">  <span class="attr">cdi:</span></span><br><span class="line">    <span class="attr">default:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">daemonsets:</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">gpu-operator</span></span><br><span class="line">      <span class="attr">helm.sh/chart:</span> <span class="string">gpu-operator-v23.9.0</span></span><br><span class="line">    <span class="attr">priorityClassName:</span> <span class="string">system-node-critical</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">    <span class="attr">tolerations:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">      <span class="attr">key:</span> <span class="string">nvidia.com/gpu</span></span><br><span class="line">      <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">    <span class="attr">updateStrategy:</span> <span class="string">RollingUpdate</span></span><br><span class="line">  <span class="attr">dcgm:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">hostPort:</span> <span class="number">5555</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">dcgm</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">nvcr.io/nvidia/cloud-native</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">3.2</span><span class="number">.6</span><span class="number">-1</span><span class="string">-ubuntu20.04</span></span><br><span class="line">  <span class="attr">dcgmExporter:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DCGM_EXPORTER_LISTEN</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">:9400</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DCGM_EXPORTER_KUBERNETES</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DCGM_EXPORTER_COLLECTORS</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">/etc/dcgm-exporter/dcp-metrics-included.csv</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">dcgm-exporter</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">nvcr.io/nvidia/k8s</span></span><br><span class="line">    <span class="attr">serviceMonitor:</span></span><br><span class="line">      <span class="attr">additionalLabels:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">honorLabels:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">interval:</span> <span class="string">15s</span></span><br><span class="line">      <span class="attr">relabelings:</span> []</span><br><span class="line">    <span class="attr">version:</span> <span class="number">3.2</span><span class="number">.6</span><span class="number">-3.1</span><span class="number">.9</span><span class="string">-ubuntu20.04</span></span><br><span class="line">  <span class="attr">devicePlugin:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">default:</span> <span class="string">any</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">time-slicing-config-all</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PASS_DEVICE_SPECS</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FAIL_ON_INIT_ERROR</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DEVICE_LIST_STRATEGY</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">envvar</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DEVICE_ID_STRATEGY</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">uuid</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NVIDIA_VISIBLE_DEVICES</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">all</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NVIDIA_DRIVER_CAPABILITIES</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">all</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">k8s-device-plugin</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">nvcr.io/nvidia</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v0.14.2-ubi8</span></span><br><span class="line">  <span class="attr">driver:</span></span><br><span class="line">    <span class="attr">certConfig:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">cugpudriver-lzw</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">kernelModuleConfig:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">licensingConfig:</span></span><br><span class="line">      <span class="attr">configMapName:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">nlsEnabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">manager:</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ENABLE_GPU_POD_EVICTION</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ENABLE_AUTO_DRAIN</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DRAIN_USE_FORCE</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DRAIN_POD_SELECTOR_LABEL</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DRAIN_TIMEOUT_SECONDS</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">0s</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DRAIN_DELETE_EMPTYDIR_DATA</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">k8s-driver-manager</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">repository:</span> <span class="string">nvcr.io/nvidia/cloud-native</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v0.6.4</span></span><br><span class="line">    <span class="attr">rdma:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">useHostMofed:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">repoConfig:</span></span><br><span class="line">      <span class="attr">configMapName:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">docker.io/library</span></span><br><span class="line">    <span class="attr">startupProbe:</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">120</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">60</span></span><br><span class="line">    <span class="attr">upgradePolicy:</span></span><br><span class="line">      <span class="attr">autoUpgrade:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">drain:</span></span><br><span class="line">        <span class="attr">deleteEmptyDir:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">enable:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">force:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">timeoutSeconds:</span> <span class="number">300</span></span><br><span class="line">      <span class="attr">maxParallelUpgrades:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">25</span><span class="string">%</span></span><br><span class="line">      <span class="attr">podDeletion:</span></span><br><span class="line">        <span class="attr">deleteEmptyDir:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">force:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">timeoutSeconds:</span> <span class="number">300</span></span><br><span class="line">      <span class="attr">waitForCompletion:</span></span><br><span class="line">        <span class="attr">timeoutSeconds:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">useNvidiaDriverCRD:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">usePrecompiled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">11.7</span><span class="number">.1</span><span class="number">-510.108</span><span class="number">.03</span></span><br><span class="line">    <span class="attr">virtualTopology:</span></span><br><span class="line">      <span class="attr">config:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">gfd:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GFD_SLEEP_INTERVAL</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">60s</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GFD_FAIL_ON_INIT_ERROR</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">gpu-feature-discovery</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">nvcr.io/nvidia</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v0.8.2-ubi8</span></span><br><span class="line">  <span class="attr">kataManager:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">artifactsDir:</span> <span class="string">/opt/nvidia-gpu-operator/artifacts/runtimeclasses</span></span><br><span class="line">      <span class="attr">runtimeClasses:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">artifacts:</span></span><br><span class="line">          <span class="attr">pullSecret:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">          <span class="attr">url:</span> <span class="string">nvcr.io/nvidia/cloud-native/kata-gpu-artifacts:ubuntu22.04-535.54.03</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">kata-qemu-nvidia-gpu</span></span><br><span class="line">        <span class="attr">nodeSelector:</span> &#123;&#125;</span><br><span class="line">      <span class="bullet">-</span> <span class="attr">artifacts:</span></span><br><span class="line">          <span class="attr">pullSecret:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">          <span class="attr">url:</span> <span class="string">nvcr.io/nvidia/cloud-native/kata-gpu-artifacts:ubuntu22.04-535.86.10-snp</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">kata-qemu-nvidia-gpu-snp</span></span><br><span class="line">        <span class="attr">nodeSelector:</span></span><br><span class="line">          <span class="attr">nvidia.com/cc.capable:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">k8s-kata-manager</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">nvcr.io/nvidia/cloud-native</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v0.1.2</span></span><br><span class="line">  <span class="attr">mig:</span></span><br><span class="line">    <span class="attr">strategy:</span> <span class="string">single</span></span><br><span class="line">  <span class="attr">migManager:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">default:</span> <span class="string">all-disabled</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">default-mig-parted-config</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">WITH_REBOOT</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">    <span class="attr">gpuClientsConfig:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">k8s-mig-manager</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">nvcr.io/nvidia/cloud-native</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v0.5.5-ubuntu20.04</span></span><br><span class="line">  <span class="attr">nodeStatusExporter:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">gpu-operator-validator</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">nvcr.io/nvidia/cloud-native</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v23.9.0</span></span><br><span class="line">  <span class="attr">operator:</span></span><br><span class="line">    <span class="attr">defaultRuntime:</span> <span class="string">containerd</span></span><br><span class="line">    <span class="attr">initContainer:</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">cuda</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">repository:</span> <span class="string">nvcr.io/nvidia</span></span><br><span class="line">      <span class="attr">version:</span> <span class="number">12.2</span><span class="number">.2</span><span class="string">-base-ubi8</span></span><br><span class="line">    <span class="attr">runtimeClass:</span> <span class="string">nvidia</span></span><br><span class="line">  <span class="attr">psa:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">psp:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">sandboxDevicePlugin:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">kubevirt-gpu-device-plugin</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">nvcr.io/nvidia</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v1.2.3</span></span><br><span class="line">  <span class="attr">sandboxWorkloads:</span></span><br><span class="line">    <span class="attr">defaultWorkload:</span> <span class="string">container</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">toolkit:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">container-toolkit</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">installDir:</span> <span class="string">/usr/local/nvidia</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">nvcr.io/nvidia/k8s</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v1.13.5-centos7</span></span><br><span class="line">  <span class="attr">validator:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">gpu-operator-validator</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">plugin:</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">WITH_WORKLOAD</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">nvcr.io/nvidia/cloud-native</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v23.9.0</span></span><br><span class="line">  <span class="attr">vfioManager:</span></span><br><span class="line">    <span class="attr">driverManager:</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ENABLE_GPU_POD_EVICTION</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ENABLE_AUTO_DRAIN</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">k8s-driver-manager</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">repository:</span> <span class="string">nvcr.io/nvidia/cloud-native</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v0.6.2</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">cuda</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">nvcr.io/nvidia</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">12.2</span><span class="number">.2</span><span class="string">-base-ubi8</span></span><br><span class="line">  <span class="attr">vgpuDeviceManager:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">default:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">vgpu-device-manager</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">nvcr.io/nvidia/cloud-native</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v0.2.4</span></span><br><span class="line">  <span class="attr">vgpuManager:</span></span><br><span class="line">    <span class="attr">driverManager:</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ENABLE_GPU_POD_EVICTION</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ENABLE_AUTO_DRAIN</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">k8s-driver-manager</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">repository:</span> <span class="string">nvcr.io/nvidia/cloud-native</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v0.6.4</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">vgpu-manager</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2023-12-11T07:07:54Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">ClusterPolicy</span> <span class="string">is</span> <span class="string">ready</span> <span class="string">as</span> <span class="string">all</span> <span class="string">resources</span> <span class="string">have</span> <span class="string">been</span> <span class="string">successfully</span> <span class="string">reconciled</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">Reconciled</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Ready</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2023-12-11T07:07:54Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">Ready</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;False&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Error</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">state:</span> <span class="string">ready</span></span><br></pre></td></tr></table></figure>

<p>可以看到在 CR 的 spec 部分保存了各组件的配置信息，这些配置信息来源于 helm chart 的 values.yaml。</p>
<p>另外，出了保存各组件的配置信息，在 status 部分，还有一个字段state保存 gpu-operator 状态。</p>
<h3 id="nvidiadrivers-nvidia-com"><a href="#nvidiadrivers-nvidia-com" class="headerlink" title="nvidiadrivers.nvidia.com"></a>nvidiadrivers.nvidia.com</h3><p>您可以创建一个或多个NVIDIA驱动程序自定义资源实例，通过 nodeSelector 以指定要在特定节点上配置的NVIDIA GPU驱动程序类型和驱动程序版本。<a target="_blank" rel="noopener" href="https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/latest/gpu-driver-configuration.html">nvidiadrivers.nvidia.com文档</a></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">nvidia.com/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NVIDIADriver</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">demo-gold</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">driverType:</span> <span class="string">gpu</span></span><br><span class="line">  <span class="attr">env:</span> []</span><br><span class="line">  <span class="attr">image:</span> <span class="string">driver</span></span><br><span class="line">  <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">imagePullSecrets:</span> []</span><br><span class="line">  <span class="attr">manager:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">driver.config:</span> <span class="string">&quot;gold&quot;</span></span><br><span class="line">  <span class="attr">repository:</span> <span class="string">nvcr.io/nvidia</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">&quot;535.104.12&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="nodefeatures-nfd-k8s-sigs-io"><a href="#nodefeatures-nfd-k8s-sigs-io" class="headerlink" title="nodefeatures.nfd.k8s-sigs.io"></a>nodefeatures.nfd.k8s-sigs.io</h3><p>// TODO</p>
<h3 id="nodefeaturerules-nfd-k8s-sigs-io"><a href="#nodefeaturerules-nfd-k8s-sigs-io" class="headerlink" title="nodefeaturerules.nfd.k8s-sigs.io"></a>nodefeaturerules.nfd.k8s-sigs.io</h3><p>// TODO</p>
<p>介绍完，NVIDIA/gpu-operator项目自定义CRD资源后，接下来，我们将对 ClusterPolicy-Controller、NVIDIADriver-Controller、Upgrade-Controller进行分析</p>
<h2 id="ClusterPolicy-Controller-分析"><a href="#ClusterPolicy-Controller-分析" class="headerlink" title="ClusterPolicy-Controller 分析"></a>ClusterPolicy-Controller 分析</h2><p>clusterpolicy官方文档：<a target="_blank" rel="noopener" href="https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/latest/getting-started.html">https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/latest/getting-started.html</a></p>
<p>clusterpolicy-controller 是 NVIDIA/gpu-operator 中三个控制器中的一个，也是比较最重要的一个控制器，它主要负责，各个组件的编排部署，解决比较繁琐的部署问题。</p>
<h3 id="ClusterPolicy-Controller-逻辑图"><a href="#ClusterPolicy-Controller-逻辑图" class="headerlink" title="ClusterPolicy-Controller 逻辑图"></a>ClusterPolicy-Controller 逻辑图</h3><img src="/2023/12/13/04/cluster-policy-controller%E9%80%BB%E8%BE%91%E5%9B%BE-3040552.png" class="" title="cluster-policy-controller逻辑图">



<p>clusterpolicy-controller控制器主要分为以下几个步骤：</p>
<p>1、node-feature-discovery，给node节点打上cpu、pci设备等标签；</p>
<p>2、获取 <code>clusterpolicies.nvidia.com</code> instance实例；</p>
<p>3、从容器目录<code>/opt/gpu-operator/</code>读取各个组件的yaml模板；</p>
<p>4、根据第1步，node节点的标签，过滤出 gpu nodeList；</p>
<p>5、根据第2、3步，依照clusterpolicy-instance的配置，渲染得到最终yaml文件；</p>
<p>6、若<code>instance.Spec.Driver.UseNvidiaDriverCRD==true</code>, 则删除所有driver-daemonSet owned by cluster policy；</p>
<p>7、按照组件依赖顺序依次部署各个组件。</p>
<h3 id="ClusterPolicy-Controller-整体流程图"><a href="#ClusterPolicy-Controller-整体流程图" class="headerlink" title="ClusterPolicy-Controller 整体流程图"></a>ClusterPolicy-Controller 整体流程图</h3><img src="/2023/12/13/04/cluster-policy-controller.png" class="" title="cluster-policy-controller">



<h3 id="ClusterPolicy-Controller-源码分析"><a href="#ClusterPolicy-Controller-源码分析" class="headerlink" title="ClusterPolicy-Controller 源码分析"></a>ClusterPolicy-Controller 源码分析</h3><p>1、首先，我们从ClusterPolicyController初始化开始分析</p>
<p><u><em>gpu-operator/controllers/cluster_policy_controller.go#L352</em></u></p>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *ClusterPolicyReconciler)</span></span> SetupWithManager(ctx context.Context, mgr ctrl.Manager) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="comment">// 1、创建 ClusterPolicyController</span></span><br><span class="line">	c, err := controller.New(<span class="string">&quot;clusterpolicy-controller&quot;</span>, mgr, controller.Options&#123;Reconciler: r, MaxConcurrentReconciles: <span class="number">1</span>, RateLimiter: workqueue.NewItemExponentialFailureRateLimiter(minDelayCR, maxDelayCR)&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	r.conditionUpdater = conditions.NewClusterPolicyUpdater(mgr.GetClient())</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 2、watch clusterpolicy 资源，将变化的clusterpolicy实例入队</span></span><br><span class="line">	err = c.Watch(source.Kind(mgr.GetCache(), &amp;gpuv1.ClusterPolicy&#123;&#125;), &amp;handler.EnqueueRequestForObject&#123;&#125;, predicate.GenerationChangedPredicate&#123;&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">  <span class="comment">// 3、watch gpu node节点labels变化，将所有的clusterpolicy实例入队</span></span><br><span class="line">	err = addWatchNewGPUNode(ctx, r, c, mgr)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">  <span class="comment">// 4、watch damonSet owned by ClusterPolicy</span></span><br><span class="line">	err = c.Watch(source.Kind(mgr.GetCache(), &amp;appsv1.DaemonSet&#123;&#125;), handler.EnqueueRequestForOwner(mgr.GetScheme(), mgr.GetRESTMapper(), &amp;gpuv1.ClusterPolicy&#123;&#125;, handler.OnlyControllerOwner()))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">  <span class="comment">// 5、给daemonSet增加index索引值</span></span><br><span class="line">	<span class="keyword">if</span> err := mgr.GetFieldIndexer().IndexField(ctx, &amp;appsv1.DaemonSet&#123;&#125;, clusterPolicyControllerIndexKey, <span class="function"><span class="keyword">func</span><span class="params">(rawObj client.Object)</span></span> []<span class="type">string</span> &#123;</span><br><span class="line">		ds := rawObj.(*appsv1.DaemonSet)</span><br><span class="line">		owner := metav1.GetControllerOf(ds)</span><br><span class="line">		<span class="keyword">if</span> owner == <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> owner.APIVersion != gpuv1.GroupVersion.String() || owner.Kind != <span class="string">&quot;ClusterPolicy&quot;</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> []<span class="type">string</span>&#123;owner.Name&#125;</span><br><span class="line">	&#125;); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to add index key: %w&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、接下来，我们进入正题，分析 Reconcile 函数</p>
<p><u><em>gpu-operator/controllers/cluster_policy_controller.go#L94</em></u></p>
<p>2.1、这里主要是从workqueue中，获取clusterpolicy-instance，下文中提到的 instance 均指向该资源。</p>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line">err := r.Client.Get(ctx, req.NamespacedName, instance)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">	err = fmt.Errorf(<span class="string">&quot;Failed to get ClusterPolicy object: %v&quot;</span>, err)</span><br><span class="line">	r.Log.Error(<span class="literal">nil</span>, err.Error())</span><br><span class="line">	clusterPolicyCtrl.operatorMetrics.reconciliationStatus.Set(reconciliationStatusClusterPolicyUnavailable)</span><br><span class="line">	<span class="keyword">if</span> apierrors.IsNotFound(err) &#123;</span><br><span class="line">		<span class="comment">// Request object not found, could have been deleted after reconcile request.</span></span><br><span class="line">		<span class="comment">// Owned objects are automatically garbage collected. For additional cleanup logic use finalizers.</span></span><br><span class="line">		<span class="comment">// Return and don&#x27;t requeue</span></span><br><span class="line">		<span class="keyword">return</span> reconcile.Result&#123;&#125;, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Error reading the object - requeue the request.</span></span><br><span class="line">	condErr = r.conditionUpdater.SetConditionsError(ctx, instance, conditions.ReconcileFailed, err.Error())</span><br><span class="line">	<span class="keyword">if</span> condErr != <span class="literal">nil</span> &#123;</span><br><span class="line">		r.Log.V(consts.LogLevelDebug).Error(<span class="literal">nil</span>, condErr.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> reconcile.Result&#123;&#125;, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.2、下面是clusterPolicyCtr.init初始获取组件配置文件，为下面，部署各个组件做准备</p>
<p><u><em>gpu-operator/controllers/cluster_policy_controller.go#L128</em></u></p>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line">err = clusterPolicyCtrl.init(ctx, r, instance)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">	err = fmt.Errorf(<span class="string">&quot;Failed to initialize ClusterPolicy controller: %v&quot;</span>, err)</span><br><span class="line">	r.Log.Error(<span class="literal">nil</span>, err.Error())</span><br><span class="line">	condErr = r.conditionUpdater.SetConditionsError(ctx, instance, conditions.ReconcileFailed, err.Error())</span><br><span class="line">	<span class="keyword">if</span> condErr != <span class="literal">nil</span> &#123;</span><br><span class="line">		r.Log.V(consts.LogLevelDebug).Error(<span class="literal">nil</span>, condErr.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> clusterPolicyCtrl.operatorMetrics != <span class="literal">nil</span> &#123;</span><br><span class="line">		clusterPolicyCtrl.operatorMetrics.reconciliationStatus.Set(reconciliationStatusClusterPolicyUnavailable)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ctrl.Result&#123;&#125;, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.2.1、init函数是获取组件配置文件，比较重要的函数，接下来，着重分析这一块代码</p>
<p><u><em>gpu-operator/controllers/state_manager.go#L753</em></u></p>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *ClusterPolicyController)</span></span> init(ctx context.Context, reconciler *ClusterPolicyReconciler, clusterPolicy *gpuv1.ClusterPolicy) <span class="type">error</span> &#123;	</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// 1、读取 assets 目录下各个组件的yaml的模板文件</span></span><br><span class="line">	addState(n, <span class="string">&quot;/opt/gpu-operator/pre-requisites&quot;</span>)</span><br><span class="line">	addState(n, <span class="string">&quot;/opt/gpu-operator/state-operator-metrics&quot;</span>)</span><br><span class="line">	addState(n, <span class="string">&quot;/opt/gpu-operator/state-driver&quot;</span>)</span><br><span class="line">	addState(n, <span class="string">&quot;/opt/gpu-operator/state-container-toolkit&quot;</span>)</span><br><span class="line">	addState(n, <span class="string">&quot;/opt/gpu-operator/state-operator-validation&quot;</span>)</span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">	<span class="comment">// 2、给gpu node节点打gpuLabels，并返回gpuNodeCount</span></span><br><span class="line">	hasNFDLabels, gpuNodeCount, err := n.labelGPUNodes()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	n.hasGPUNodes = gpuNodeCount != <span class="number">0</span></span><br><span class="line">	n.hasNFDLabels = hasNFDLabels</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 3、给gpu node节点增加annotation</span></span><br><span class="line">	err = n.applyDriverAutoUpgradeAnnotation()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 4、获取node节点的runtime</span></span><br><span class="line">	err = n.getRuntime()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">  n.rec.Log.Info(fmt.Sprintf(<span class="string">&quot;Using container runtime: %s&quot;</span>, n.runtime.String()))</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>init函数主要做以下几件事：</p>
<p>1、通过读取容器目录 <code>/opt/gpu-operator/&lt;component-name&gt;</code>，获取组件yaml模板文件</p>
<p>2、判断node节点是否为gpu节点，若为gpu节点，给node节点打gpuLabels <code>&quot;nvidia.com/gpu.present&quot;:&quot;true&quot;</code>，并返回gpuNodeCount、hasNFDLables</p>
<blockquote>
<p>hasNFDLabels判断依据：遍历nodelist，检索每个node节点annotation，只要存在前缀为<code>feature.node.kubernetes.io/</code>的annotatin，则设置hasNFDLabels=true；反之，则hasNFDLabels=false</p>
</blockquote>
<p>3、根据 <code>instance.spec.upgradePolicy.autoGrade==true &amp;&amp; sanboxEnable == false</code>，结果为true，则给node节点加上<code>nvidia.com/gpu-driver-upgrade-enabled=true</code>；若结果为false，则删除该annotation</p>
<p>4、检测工作节点上的runtime，获取nodelist，遍历nodelist，一旦有一个runtime=containerd，则默认所有节点runtime为containerd。</p>
<p>// TODO</p>
<h2 id="NVIDIADriver-Controller-分析"><a href="#NVIDIADriver-Controller-分析" class="headerlink" title="NVIDIADriver-Controller 分析"></a>NVIDIADriver-Controller 分析</h2><p>nvidiaDriverCRD官方文档：<a target="_blank" rel="noopener" href="https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/latest/gpu-driver-configuration.html">https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/latest/gpu-driver-configuration.html</a></p>
<p>NVIDIADriver-Controller 是相对于clusterpolicy在driver部署方面的一个增强，以前的clusterpolicy的方式部署，所有节点只能部署同一种driver，有了自定义 crd<code>nvidiadrivers.nvidia.com</code>和 NVIDIADriver-Controller ，可以实现nodePool方式，更加精细化的部署编排。</p>
<img src="/2023/12/13/04/nvd-basics.svg" class="" title="_images&#x2F;nvd-basics.svg">



<h3 id="ClusterPolicyCRD-与-NVIDIADriverCRD-对比"><a href="#ClusterPolicyCRD-与-NVIDIADriverCRD-对比" class="headerlink" title="ClusterPolicyCRD 与 NVIDIADriverCRD  对比"></a>ClusterPolicyCRD 与 NVIDIADriverCRD  对比</h3><table>
<thead>
<tr>
<th>Cluster Policy CRD</th>
<th>NVIDIA Driver CRD</th>
</tr>
</thead>
<tbody><tr>
<td>在所有节点上支持单一驱动类型和版本</td>
<td>支持不同节点的多种驱动类型和版本</td>
</tr>
<tr>
<td>不支持多个操作系统版本，这个限制使在节点上执行操作系统升级变得复杂</td>
<td>支持节点的多个操作系统版本</td>
</tr>
</tbody></table>
<h3 id="NVIDIADriver-Controller-逻辑图"><a href="#NVIDIADriver-Controller-逻辑图" class="headerlink" title="NVIDIADriver-Controller 逻辑图"></a>NVIDIADriver-Controller 逻辑图</h3><img src="/2023/12/13/04/nvidia-driver-controller%E9%80%BB%E8%BE%91%E5%9B%BE.png" class="" title="nvidia-driver-controller逻辑图">

<p>1、获取 NVIDIADriver-instance 实例；</p>
<p>2、根据 instance 的 nodeSelector 得到 nodeList；</p>
<p>3、根据 Node-Feature-Discovery 给node节点打的标签 <code>feature.node.kubernetes.io/system-os_release.ID</code>、<code>feature.node.kubernetes.io/system-os_release.VERSION_ID</code>, 将nodeList 拆分成小的nodePool，格式为：<code>var map[string]nodePool=&#123;&quot;centos7&quot;:&quot;nodePool-1&quot;,&quot;centos8&quot;:&quot;nodePool-2&quot;&#125;</code>。若不存在这两个标签的node节点，则忽略；</p>
<p>4、根据 instance 的配置字段，渲染 driver-daemonSet的 yaml 文件。controller 会获取宿主机的 <code>&lt;osID&gt;&lt;osVersion&gt;</code>，加在driver-daemonSet image的 tag 后面，格式如下：<code>&lt;repository&gt;/&lt;image&gt;:&lt;version&gt;-&lt;osID&gt;&lt;osVersoon&gt;</code></p>
<p>5、最后，渲染的 yaml 文件，创建或更新 driver-daemonSet。</p>
<h3 id="NVIDIADriver-Controller-整体流程图"><a href="#NVIDIADriver-Controller-整体流程图" class="headerlink" title="NVIDIADriver-Controller 整体流程图"></a>NVIDIADriver-Controller 整体流程图</h3><img src="/2023/12/13/04/NVIDIADriver.png" class="" title="NVIDIADriver">

<h2 id="Upgrade-Controller-分析"><a href="#Upgrade-Controller-分析" class="headerlink" title="Upgrade-Controller 分析"></a>Upgrade-Controller 分析</h2><p>upgrad-controller官方文档：<a target="_blank" rel="noopener" href="https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/latest/gpu-driver-upgrades.html">https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/latest/gpu-driver-upgrades.html</a></p>
<img src="/2023/12/13/04/upgrade-controller-state-machine.png" class="" title="_images&#x2F;upgrade-controller-state-machine.png">

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="http://lizhewei91.github.io/2023/12/13/04/" title="NVIDIA/gpu-operator分析: 原理解析" target="_blank" rel="external">http://lizhewei91.github.io/2023/12/13/04/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/lizhewei91" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/lizhewei91" target="_blank"><span class="text-dark">李哲伟</span><small class="ml-1x">Cloud Native Developer</small></a></h3>
        <div>专注于云原生领域。</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="vcomments"></div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2023/12/20/53/" title="NVIDIA/gpu-operator使用总结（一）:time-slicing实现GPU共享"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2023/10/24/08/" title="在 kubernetes 集群中实现 gpu 共享调度"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn " data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">    <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
    
  </div>
  </div>
</nav>
  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>感谢您的支持，我会继续努力的!</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">扫码打赏，你说多少就多少</p>
              <p class="text-grey">打开支付宝扫一扫，即可进行扫码打赏哦</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">扫码打赏，你说多少就多少</p>
              <p class="text-grey">打开微信扫一扫，即可进行扫码打赏哦</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/lizhewei91" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>



    <script>
(function ($) {
    $('.search-form').on('submit', function (e) {
        var keyword = $('.search-form-input[name="wd"]').val();
        window.location = 'https://www.baidu.com/s?wd=site:lizhewei91.github.io ' + keyword;
        return false;
    });
})(jQuery);
</script>




   




   
    
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/valine"></script>
  <script type="text/javascript">
  var GUEST = ['nick', 'mail', 'link'];
  var meta = 'nick,mail,link';
  meta = meta.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#vcomments',
    verify: false,
    notify: false,
    appId: '',
    appKey: '',
    placeholder: 'Just go go',
    avatar: 'mm',
    meta: meta,
    pageSize: '10' || 10,
    visitor: false
  });
  </script>

     







</body>
</html>